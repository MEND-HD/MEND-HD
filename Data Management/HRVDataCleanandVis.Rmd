---
title: "HRV 14-Day Analysis"
author: "Meghan"
output: html_document
---

## Load Required Libraries

```{r setup, message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(scales)
```

---

## Load and Clean Data

```{r data-cleaning}
# 1️⃣ Load data
data <- read.csv("HRVdays.csv", stringsAsFactors = FALSE)

# 2️⃣ Convert DATE to Date format
data$DATE <- as.Date(data$DATE)

# 3️⃣ Remove subjects containing "test"
data_clean <- data %>%
  filter(!grepl("test", SUBJECT, ignore.case = TRUE))

# 4️⃣ Remove rows where reliability is NULL or NA
data_clean <- data_clean %>%
  filter(!is.na(HRV_RELIABILITY_90PCT_24H) &
           HRV_RELIABILITY_90PCT_24H != "NULL")

# 5️⃣ Keep first 14 valid days per subject
data_14days <- data_clean %>%
  group_by(SUBJECT) %>%
  arrange(DATE) %>%
  mutate(first_valid_date = min(DATE)) %>%
  filter(DATE >= first_valid_date &
           DATE <= first_valid_date + 13) %>%
  ungroup()

# 6️⃣ Convert numeric columns
data_14days <- data_14days %>%
  mutate(
    LF_POWER_90PCT_24H = as.numeric(LF_POWER_90PCT_24H),
    HF_POWER_90PCT_24H = as.numeric(HF_POWER_90PCT_24H),
    SDNN_90PCT_24H = as.numeric(SDNN_90PCT_24H)
  )

# 7️⃣ Create LF/HF ratio
data_14days <- data_14days %>%
  mutate(LF_HF_ratio = LF_POWER_90PCT_24H / HF_POWER_90PCT_24H)

# 8️⃣ Create Study Day variable (1–14)
data_14days <- data_14days %>%
  group_by(SUBJECT) %>%
  arrange(DATE) %>%
  mutate(Day = as.numeric(DATE - min(DATE)) + 1) %>%
  ungroup()
```

---

## Visualization 1: LF/HF Ratio Across 14 Days

```{r plot-lfhf, fig.width=8, fig.height=6}
p1 <- ggplot(data_14days,
             aes(x = Day,
                 y = LF_HF_ratio,
                 color = factor(SUBJECT),
                 group = SUBJECT)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = 1:14) +
  scale_y_continuous(breaks = pretty_breaks(n = 6)) +
  labs(title = "LF/HF Ratio Across First 14 Days",
       x = "Study Day",
       y = "LF/HF Ratio",
       color = "Subject") +
  theme_classic(base_size = 16) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    legend.title = element_text(face = "bold"),
    axis.text = element_text(color = "black")
  )

p1
```

---

## Visualization 2: SDNN Across 14 Days

```{r plot-sdnn, fig.width=8, fig.height=6}
p2 <- ggplot(data_14days,
             aes(x = Day,
                 y = SDNN_90PCT_24H,
                 color = factor(SUBJECT),
                 group = SUBJECT)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = 1:14) +
  scale_y_continuous(breaks = pretty_breaks(n = 6)) +
  labs(title = "SDNN Across First 14 Days",
       x = "Study Day",
       y = "SDNN (ms)",
       color = "Subject") +
  theme_classic(base_size = 16) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    legend.title = element_text(face = "bold"),
    axis.text = element_text(color = "black")
  )

p2
```
